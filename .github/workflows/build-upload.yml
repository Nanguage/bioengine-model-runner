name: Build and Upload Models
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron:  '0 1,13 * * *'

jobs:
  # Label of the container job
  build-and-upload:
    # You must use a Linux environment when using service containers or container jobs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.4.0
      - name: Set up Python
        uses: actions/setup-python@v2.3.1
        with:
          python-version: 3.8
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.S3_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET }}
          aws-region: us-east-2
      - name: Copy model runner to the model repository
        run: |
          aws --endpoint-url=${{ secrets.S3_ENDPOINT }} s3 sync ./src/bioengine-model-runner s3://model-repository/bioengine-model-runner
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy tqdm requests boto3 ruamel.yaml jinja2 pytest pytest-asyncio
      - name: Convert models
        run: python scripts/export_model_to_triton.py --download-weights --upload --skip-exists --remove-after-upload --endpoint-url=${{ secrets.S3_ENDPOINT }} --access-key-id=${{ secrets.S3_KEY }} --secret-access-key=${{ secrets.S3_SECRET }} --bucket=model-repository --prefix=
      - name: Deploy model repository manifest to gh-pages ðŸš€
        if: github.ref == 'refs/heads/main'
        uses: JamesIves/github-pages-deploy-action@v4.2.3
        with:
          clean: false
          branch: gh-pages
          folder: dist
